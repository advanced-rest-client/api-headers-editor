<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-headers-editor test</title>

  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>

  <script src="./amf-loader.js"></script>
</head>
<body>

  <test-fixture id="BasicTestFixture">
    <template>
      <api-headers-editor></api-headers-editor>
    </template>
  </test-fixture>

  <script type="module">
  import '../api-headers-editor.js';
  import {ns} from '@api-components/amf-helper-mixin/amf-helper-mixin.js';
  /* global AmfLoader */
  suite('AMF model tests', () => {
    function getHeadersModel(element, amfModel) {
      const webApi = element._computeWebApi(amfModel);
      const endpoint = element._computeEndpointByPath(webApi, '/endpoint');
      const opKey = element._getAmfKey(ns.w3.hydra.supportedOperation);
      const ops = element._ensureArray(endpoint[opKey]);
      const expects = element._computeExpects(ops[0]);
      const hKey = element._getAmfKey(ns.raml.vocabularies.http + 'header');
      return element._ensureArray(expects[hKey]);
    }

    [
      ['Full model', false],
      ['Compact model', true]
    ].forEach((item) => {
      suite(item[0], () => {
        let amfModel;
        suiteSetup(() => {
          return AmfLoader.load(item[1])
          .then((data) => {
            amfModel = data;
          });
        });

        let element;
        setup((done) => {
          const transformer = document.createElement('api-view-model-transformer');
          transformer.clearCache();
          element = fixture('BasicTestFixture');
          element.addEventListener('value-changed', function f(e) {
            if (!e.detail.value) {
              return;
            }
            element.removeEventListener('value-changed', f);
            flush(() => done());
          });
          element.amfModel = amfModel;
          element.amfHeaders = getHeadersModel(element, amfModel);
        });

        test('Generates view model from AMF shape', () => {
          assert.typeOf(element.viewModel, 'array');
          assert.lengthOf(element.viewModel, 19);
        });

        test('Model respects default values', () => {
          const xRequired = element.viewModel[4];
          assert.equal(xRequired.value, 'default required value');
        });

        test('Validates the editor', () => {
          const result = element.validate();
          assert.isFalse(result);
        });

        test('Generates value from the model', (done) => {
          setTimeout(() => {
            const value = element.value;
            assert.equal(value.indexOf('ETag'), -1, 'Etag is not present (optional)');
            assert.notEqual(value.indexOf('Cache-Control'), -1, 'Cache-Control is present');
            assert.notEqual(value.indexOf('x-string'), -1, 'x-string is present');
            assert.equal(value.indexOf('x-optional'), -1, 'x-optional is not present (optional)');
            assert.notEqual(value.indexOf('x-required: default required value'), -1,
              'x-required is present (dafault value)');
            assert.notEqual(value.indexOf('x-union: Hello union'), -1, 'x-union is present (value from example)');
            done();
          }, 250);
        });

        test('Clears AMF values when value is cleared', (done) => {
          element.value = '';
          flush(() => {
            const vm = element.viewModel;
            assert.typeOf(vm, 'array');
            assert.lengthOf(vm, 19);
            assert.equal(vm[4].value, '');
            done();
          });
        });
      });
    });
  });
  </script>
</body>

</html>
